## IO栈

linux内核有几大几个核心模块，CPU调度、内存、文件系统、块设备。因为在工作中主要是面向数据库做内核优化，所以相对来说对IO接触的比较多，所以第一个需要学习的是IO栈。

这里放一张图片，可以大致了解IO栈。

![Linux-storage-stack-diagram_v6.2](/Users/mazhenxian/Downloads/Linux-storage-stack-diagram_v6.2.png)

首先，在日常写代码时候，我们打开一个文件或者写一个文件，通常用的都是read/write。在调用完成后，文件就自动写入或者读取了。那么对于应用层来说，从调用到返回，内核层经历了什么？

这篇只介绍IO架构大概是什么样的，具体作用和实现方式之后详细介绍。

第一个用到的模块就是文件系统，也就是上图的VFS，又叫虚拟文件系统。为什么叫虚拟文件系统呢？是因为linux内核有多种文件系统模块，例如xfs，ext4。那么不同的文件系统对外接口是不一样的，比如ext4中的写接口是ext4_write，xfs写接口是xfs_write。如果代码中写死了，是不是调用write时只能由write-->ext4_write，就实现不了多个文件系统。而提供了一层虚拟文件系统，在vfs里面写几个接口，下层文件系统只需要把vfs需要的操作给实现了，初始化文件系统时，设置回调就可以了。

举个例子，有点类似于面向对象：

```
person{
	吃
	喝
	玩
}
定义了一个人，他可以吃喝玩，但是具体怎么吃喝，这里面没有写。

Xiaoming extend person{
	吃：吃肉
	喝：喝可乐
	玩：打游戏
}

Xiaomei extend person{
	吃：吃素
	喝：白开水
	玩：看剧
}
下面这两个就是person的具体实现，person就是vfs，Xiaoming就是ext4，Xiaomei就是ext4.
```

当具体调用的时候，上层应用会先调用person（因为他不知道底层具体是什么实现），然后调用Xiaoming才知道怎么吃。那么什么时候会实现具体的文件系统呢？答案是在文件系统初始化时，会把相关实现挂到vfs的函数指针中。

文件系统是干什么用的呢？以我目前的理解就是实现 文件-内存-磁盘之间的映射。什么意思呢，就是当前文件在内存中的位置是什么，在磁盘上的位置是什么。只有知道了他们的位置，才知道需要将内存中“哪块内容”写到磁盘上“哪个位置”。



第二个需要经过的块设备层，也就是block。文件系统将构造好的IO请求（叫bio）通过一个函数submit_bio提交给block层。block层做什么的呢？将bio进一步处理，添加上一些信息，打包成一个request，然后决定如何将这些request提交到驱动层。block包含了bio的拆分、合并、排序等。做完这些事后，将打包好的request提交给驱动层。



第三个就是驱动层，驱动层接收到request之后，提交给硬件处理。处理完成后向上层返回相关信息。

下面就来看vfs的流程吧。